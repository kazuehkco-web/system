<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>é¦™æ¸¯ä»£è³¼ç®¡ç†ç³»çµ± v3</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+HK:wght@300;400;500;700;900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root{--bg:#0a0a0f;--surface:#13131a;--surface2:#1c1c28;--surface3:#252535;--border:#2a2a3d;--accent:#7c6dff;--accent2:#ff6b9d;--accent3:#00d4aa;--text:#e8e8f0;--text2:#9898b0;--text3:#5a5a75;--gold:#f5c842;--danger:#ff4d6d;--warning:#ff9f43;--success:#00d4aa;}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Noto Sans HK',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;}
.header{background:linear-gradient(135deg,var(--surface),#1a1a2e);border-bottom:1px solid var(--border);padding:14px 28px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;}
.logo{display:flex;align-items:center;gap:12px;}
.logo-icon{width:38px;height:38px;background:linear-gradient(135deg,var(--accent),var(--accent2));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;}
.logo-text{font-size:17px;font-weight:700;}
.logo-sub{font-size:10px;color:var(--text2);font-family:'Space Mono',monospace;}
.header-actions{display:flex;gap:8px;align-items:center;}
.channel-connect-row{display:flex;gap:8px;}
.ch-btn{padding:6px 12px;border-radius:8px;border:none;cursor:pointer;font-size:12px;font-weight:600;display:flex;align-items:center;gap:5px;transition:all 0.2s;position:relative;}
.ch-btn.ig{background:linear-gradient(135deg,#833ab4,#fd1d1d,#fcb045);color:#fff;}
.ch-btn.wa{background:#25d366;color:#000;}
.ch-btn.web{background:var(--accent3);color:#000;}
.ch-btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.3);}
.ch-dot{width:7px;height:7px;border-radius:50%;background:#0f0;display:inline-block;animation:blink 2s infinite;}
@keyframes blink{0%,100%{opacity:1;}50%{opacity:.3;}}
.btn{padding:8px 14px;border-radius:8px;border:none;cursor:pointer;font-family:'Noto Sans HK',sans-serif;font-size:13px;font-weight:500;transition:all 0.2s;display:inline-flex;align-items:center;gap:6px;}
.btn-primary{background:var(--accent);color:#fff;}
.btn-primary:hover{background:#6b5ce7;transform:translateY(-1px);}
.btn-ghost{background:var(--surface3);color:var(--text2);border:1px solid var(--border);}
.btn-ghost:hover{background:var(--surface2);color:var(--text);}
.btn-danger{background:var(--danger);color:#fff;}
.btn-danger:hover{background:#e0314f;}
.btn-success{background:var(--success);color:#000;}
.btn-warning{background:var(--warning);color:#000;}
.layout{display:flex;height:calc(100vh - 60px);}
.sidebar{width:210px;background:var(--surface);border-right:1px solid var(--border);padding:16px 0;flex-shrink:0;overflow-y:auto;}
.nav-label{font-size:10px;color:var(--text3);font-family:'Space Mono',monospace;letter-spacing:1.5px;text-transform:uppercase;padding:0 16px;margin-bottom:5px;margin-top:12px;}
.nav-item{display:flex;align-items:center;gap:9px;padding:9px 12px;margin:0 8px 2px;border-radius:8px;cursor:pointer;font-size:13px;color:var(--text2);transition:all 0.15s;}
.nav-item:hover{background:var(--surface2);color:var(--text);}
.nav-item.active{background:linear-gradient(135deg,rgba(124,109,255,.2),rgba(255,107,157,.1));color:var(--accent);border:1px solid rgba(124,109,255,.3);}
.nav-badge{margin-left:auto;background:var(--accent);color:#fff;font-size:10px;padding:1px 5px;border-radius:10px;font-family:'Space Mono',monospace;}
.nav-badge.red{background:var(--danger);}
.nav-badge.green{background:var(--success);color:#000;}
.main{flex:1;overflow-y:auto;padding:24px 28px;}
.stats-row{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-bottom:24px;}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;position:relative;overflow:hidden;transition:transform .2s;}
.stat-card:hover{transform:translateY(-2px);}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;}
.stat-card.purple::before{background:linear-gradient(90deg,var(--accent),transparent);}
.stat-card.pink::before{background:linear-gradient(90deg,var(--accent2),transparent);}
.stat-card.green::before{background:linear-gradient(90deg,var(--success),transparent);}
.stat-card.gold::before{background:linear-gradient(90deg,var(--gold),transparent);}
.stat-card.red::before{background:linear-gradient(90deg,var(--danger),transparent);}
.stat-num{font-size:26px;font-weight:900;font-family:'Space Mono',monospace;}
.stat-num.purple{color:var(--accent);}.stat-num.pink{color:var(--accent2);}.stat-num.green{color:var(--success);}.stat-num.gold{color:var(--gold);}.stat-num.red{color:var(--danger);}
.stat-label{font-size:12px;color:var(--text2);margin-top:5px;}
.stat-sub{font-size:10px;color:var(--text3);margin-top:2px;font-family:'Space Mono',monospace;}
.section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;}
.section-title{font-size:15px;font-weight:700;display:flex;align-items:center;gap:8px;}
.filter-bar{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:12px 14px;margin-bottom:14px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
.filter-input{background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);padding:7px 11px;font-size:13px;font-family:'Noto Sans HK',sans-serif;outline:none;transition:border-color .2s;}
.filter-input:focus,.form-input:focus,.form-textarea:focus,.form-select:focus{border-color:var(--accent);}
.filter-input.wide{flex:1;min-width:180px;}
.filter-select{background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);padding:7px 11px;font-size:13px;font-family:'Noto Sans HK',sans-serif;outline:none;cursor:pointer;}
.pill{padding:5px 11px;border-radius:20px;font-size:12px;cursor:pointer;border:1px solid var(--border);background:var(--surface2);color:var(--text2);transition:all .15s;}
.pill.active{background:var(--accent);color:#fff;border-color:var(--accent);}
.pill.ig.active{background:linear-gradient(135deg,#833ab4,#fd1d1d,#fcb045);border-color:transparent;}
.pill.wa.active{background:#25d366;border-color:transparent;color:#000;}
.pill.web.active{background:var(--accent3);border-color:transparent;color:#000;}
.table-wrap{background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden;}
table{width:100%;border-collapse:collapse;}
thead{background:var(--surface2);}
th{padding:11px 13px;text-align:left;font-size:10px;color:var(--text3);font-family:'Space Mono',monospace;letter-spacing:.5px;text-transform:uppercase;border-bottom:1px solid var(--border);}
td{padding:12px 13px;border-bottom:1px solid rgba(42,42,61,.5);font-size:13px;vertical-align:middle;}
tr:last-child td{border-bottom:none;}
tr:hover td{background:rgba(124,109,255,.04);}
.status{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:500;white-space:nowrap;}
.status::before{content:'';width:5px;height:5px;border-radius:50%;flex-shrink:0;}
.s-unpaid{background:rgba(255,159,67,.15);color:var(--warning);border:1px solid rgba(255,159,67,.3);}
.s-unpaid::before{background:var(--warning);}
.s-paid{background:rgba(0,212,170,.15);color:var(--success);border:1px solid rgba(0,212,170,.3);}
.s-paid::before{background:var(--success);}
.s-unpurchased{background:rgba(152,152,176,.15);color:var(--text2);border:1px solid rgba(152,152,176,.3);}
.s-unpurchased::before{background:var(--text2);}
.s-purchased{background:rgba(124,109,255,.15);color:var(--accent);border:1px solid rgba(124,109,255,.3);}
.s-purchased::before{background:var(--accent);}
.s-kr-arrived{background:rgba(245,200,66,.15);color:var(--gold);border:1px solid rgba(245,200,66,.3);}
.s-kr-arrived::before{background:var(--gold);}
.s-kr-departed{background:rgba(255,107,157,.15);color:var(--accent2);border:1px solid rgba(255,107,157,.3);}
.s-kr-departed::before{background:var(--accent2);}
.s-hk-arrived{background:rgba(0,212,170,.15);color:var(--success);border:1px solid rgba(0,212,170,.3);}
.s-hk-arrived::before{background:var(--success);}
.s-hk-shipped{background:rgba(0,212,170,.25);color:#00ffcc;border:1px solid rgba(0,212,170,.5);}
.s-hk-shipped::before{background:#00ffcc;box-shadow:0 0 6px #00ffcc;}
.s-refund{background:rgba(255,77,109,.15);color:var(--danger);border:1px solid rgba(255,77,109,.3);}
.s-refund::before{background:var(--danger);}
.s-cancelled{background:rgba(90,90,117,.2);color:var(--text3);border:1px solid rgba(90,90,117,.3);}
.s-cancelled::before{background:var(--text3);}
.ch-tag{display:inline-flex;align-items:center;gap:3px;padding:2px 7px;border-radius:6px;font-size:11px;font-weight:600;}
.ch-ig{background:linear-gradient(135deg,#833ab4,#fd1d1d);color:#fff;}
.ch-wa{background:#25d366;color:#000;}
.ch-web{background:var(--accent3);color:#000;}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(8px);z-index:200;display:none;align-items:center;justify-content:center;padding:20px;}
.modal-overlay.open{display:flex;}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:16px;width:100%;max-width:860px;max-height:92vh;overflow-y:auto;animation:slideUp .25s ease;}
.modal.sm{max-width:440px;}.modal.md{max-width:620px;}
@keyframes slideUp{from{transform:translateY(20px);opacity:0;}to{transform:translateY(0);opacity:1;}}
.modal-header{padding:18px 22px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:var(--surface);z-index:1;}
.modal-title{font-size:15px;font-weight:700;display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
.modal-body{padding:22px;}
.modal-close{width:30px;height:30px;background:var(--surface3);border:1px solid var(--border);border-radius:7px;color:var(--text2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;transition:all .15s;}
.modal-close:hover{background:var(--danger);color:#fff;}
.form-group{margin-bottom:13px;}
.form-label{font-size:12px;color:var(--text2);margin-bottom:5px;display:block;}
.form-input,.form-textarea,.form-select{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);padding:9px 11px;font-size:13px;font-family:'Noto Sans HK',sans-serif;outline:none;transition:border-color .2s;}
.form-textarea{resize:vertical;min-height:75px;}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:11px;}
.detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.detail-section{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px;}
.detail-section.full{grid-column:1/-1;}
.detail-section h4{font-size:10px;color:var(--text3);font-family:'Space Mono',monospace;letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;}
.detail-row{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:7px;font-size:13px;}
.detail-row:last-child{margin-bottom:0;}
.detail-label{color:var(--text2);flex-shrink:0;margin-right:10px;}
.detail-value{color:var(--text);text-align:right;word-break:break-all;}
.detail-value a{color:var(--accent);text-decoration:none;}
.img-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:9px;}
.img-thumb{aspect-ratio:1;border-radius:8px;overflow:hidden;position:relative;cursor:pointer;}
.img-thumb img{width:100%;height:100%;object-fit:cover;}
.img-thumb .del-overlay{position:absolute;inset:0;background:rgba(255,77,109,.8);display:none;align-items:center;justify-content:center;font-size:20px;}
.img-thumb:hover .del-overlay{display:flex;}
.img-placeholder{aspect-ratio:1;background:var(--surface3);border:2px dashed var(--border);border-radius:8px;display:flex;flex-direction:column;align-items:center;justify-content:center;color:var(--text3);cursor:pointer;transition:all .2s;font-size:11px;gap:5px;}
.img-placeholder:hover{border-color:var(--accent);color:var(--accent);background:rgba(124,109,255,.05);}
.img-placeholder .icon{font-size:22px;}
.timeline{display:flex;align-items:center;}
.step-dot{width:26px;height:26px;border-radius:50%;border:2px solid var(--border);background:var(--surface3);display:flex;align-items:center;justify-content:center;font-size:10px;color:var(--text3);flex-shrink:0;}
.step-dot.done{border-color:var(--success);background:rgba(0,212,170,.2);color:var(--success);}
.step-dot.current{border-color:var(--accent);background:rgba(124,109,255,.2);color:var(--accent);box-shadow:0 0 10px rgba(124,109,255,.4);}
.step-line{flex:1;height:2px;background:var(--border);}
.step-line.done{background:var(--success);}
.step-label-row{display:flex;margin-top:5px;}
.step-label{font-size:9px;color:var(--text3);text-align:center;flex:1;}
.confirm-box{background:rgba(255,77,109,.1);border:1px solid rgba(255,77,109,.3);border-radius:10px;padding:14px;margin-bottom:14px;text-align:center;}
.confirm-box .ci{font-size:34px;margin-bottom:6px;}
.confirm-box p{font-size:13px;color:var(--text2);line-height:1.6;}
.action-btns{display:flex;gap:5px;}
.icon-btn{width:27px;height:27px;background:var(--surface3);border:1px solid var(--border);border-radius:6px;color:var(--text2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:13px;transition:all .15s;}
.icon-btn:hover{background:var(--accent);color:#fff;border-color:var(--accent);}
.icon-btn.del:hover{background:var(--danger);border-color:var(--danger);}
.priority{padding:2px 7px;border-radius:4px;font-size:11px;font-weight:700;}
.p-high{background:rgba(255,77,109,.2);color:var(--danger);}
.p-mid{background:rgba(255,159,67,.2);color:var(--warning);}
.p-low{background:rgba(152,152,176,.2);color:var(--text2);}
.page-section{display:none;}
.page-section.active{display:block;}
.empty-state{text-align:center;padding:36px;color:var(--text3);}
.empty-icon{font-size:44px;margin-bottom:10px;}
.photo-batch{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:14px;}
.photo-batch-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
.photo-batch-title{font-size:13px;font-weight:700;display:flex;align-items:center;gap:8px;}
.photo-batch-meta{font-size:11px;color:var(--text3);font-family:'Space Mono',monospace;}
.cards-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px;}
.info-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;text-align:center;}
.info-card h4{font-size:10px;color:var(--text3);font-family:'Space Mono',monospace;letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;}
.cs-num{font-size:34px;font-weight:900;font-family:'Space Mono',monospace;}
.cs-item{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:10px;}
.cs-item-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;}
.one-click-section{background:linear-gradient(135deg,rgba(124,109,255,.1),rgba(255,107,157,.1));border:1px solid rgba(124,109,255,.3);border-radius:12px;padding:16px;margin-bottom:20px;}
.one-click-title{font-size:14px;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:8px;}
.one-click-btns{display:flex;gap:8px;flex-wrap:wrap;}
.toast{position:fixed;bottom:22px;right:22px;background:var(--surface);border:1px solid var(--success);border-radius:10px;padding:12px 16px;z-index:999;font-size:13px;display:none;animation:slideUp .3s ease;box-shadow:0 4px 20px rgba(0,0,0,.3);max-width:320px;}
.toast.show{display:block;}
.toast.error{border-color:var(--danger);}
.inv-photo-preview{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-top:8px;}
.upload-area{border:2px dashed var(--border);border-radius:8px;padding:20px;text-align:center;cursor:pointer;transition:all .2s;color:var(--text3);}
.upload-area:hover{border-color:var(--accent);color:var(--accent);background:rgba(124,109,255,.05);}
.tab-bar{display:flex;gap:4px;margin-bottom:16px;background:var(--surface2);padding:4px;border-radius:10px;border:1px solid var(--border);}
.tab{padding:8px 14px;border-radius:8px;font-size:13px;cursor:pointer;color:var(--text2);transition:all .15s;}
.tab.active{background:var(--accent);color:#fff;}
::-webkit-scrollbar{width:5px;height:5px;}
::-webkit-scrollbar-track{background:var(--surface);}
::-webkit-scrollbar-thumb{background:var(--surface3);border-radius:3px;}
::-webkit-scrollbar-thumb:hover{background:var(--accent);}
</style>
</head>
<body>

<div class="header">
  <div class="logo">
    <div class="logo-icon">ğŸ›ï¸</div>
    <div>
      <div class="logo-text">ä»£è³¼ç®¡ç†ç³»çµ±</div>
      <div class="logo-sub">HK PROXY ORDER SYSTEM v3.0</div>
    </div>
  </div>
  <div class="header-actions">
    <div class="channel-connect-row">
      <button class="ch-btn ig" onclick="showConnect('ig')"><span class="ch-dot"></span>ğŸ“¸ Instagram</button>
      <button class="ch-btn wa" onclick="showConnect('wa')"><span class="ch-dot"></span>ğŸ’¬ WhatsApp</button>
      <button class="ch-btn web" onclick="showConnect('web')"><span class="ch-dot"></span>ğŸŒ Website</button>
    </div>
    <button class="btn btn-ghost" onclick="exportExcel()" style="margin-left:4px">ğŸ“Š åŒ¯å‡º</button>
    <button class="btn btn-primary" onclick="openOrderForm(null)">ï¼‹ æ–°å¢è¨‚å–®</button>
  </div>
</div>

<div class="layout">
<div class="sidebar">
  <div class="nav-label">ä¸»è¦åŠŸèƒ½</div>
  <div class="nav-item active" onclick="showPage('orders',this)"><span>ğŸ“¦</span> è¨‚å–®ç¸½è¦½ <span class="nav-badge" id="badge-orders">0</span></div>
  <div class="nav-item" onclick="showPage('inventory',this)"><span>ğŸª</span> ç¾è²¨åº«å­˜ <span class="nav-badge green" id="badge-inv">0</span></div>
  <div class="nav-item" onclick="showPage('photos',this)"><span>ğŸ“¸</span> åº«å­˜ç…§ç‰‡ç´€éŒ„ <span class="nav-badge" id="badge-photos">0</span></div>
  <div class="nav-item" onclick="showPage('problems',this)"><span>âš ï¸</span> å•é¡Œå›å ± <span class="nav-badge red" id="badge-prob">0</span></div>
  <div class="nav-item" onclick="showPage('cs',this)"><span>ğŸ’¬</span> å®¢æœç´€éŒ„ <span class="nav-badge" id="badge-cs">0</span></div>
  <div class="nav-label">å¿«é€Ÿç¯©é¸</div>
  <div class="nav-item" onclick="quickFilter('unpaid')"><span>ğŸ’³</span> æœªä»˜æ¬¾ <span class="nav-badge red" id="qf-unpaid">0</span></div>
  <div class="nav-item" onclick="quickFilter('purchased')"><span>ğŸ›’</span> æ¡è³¼ä¸­ <span class="nav-badge" id="qf-purchased">0</span></div>
  <div class="nav-item" onclick="quickFilter('kr-departed')"><span>âœˆï¸</span> éŸ“åœ‹å‡ºç™¼ <span class="nav-badge" id="qf-kr-departed">0</span></div>
  <div class="nav-item" onclick="quickFilter('hk-shipped')"><span>ğŸšš</span> é¦™æ¸¯ç™¼è²¨ <span class="nav-badge green" id="qf-hk-shipped">0</span></div>
  <div class="nav-item" onclick="quickFilter('refund')"><span>ğŸ”„</span> å¾…é€€æ¬¾ <span class="nav-badge red" id="qf-refund">0</span></div>
</div>

<div class="main">

<!-- ORDERS PAGE -->
<div id="page-orders" class="page-section active">
  <div class="stats-row">
    <div class="stat-card purple"><div class="stat-num purple" id="stat-total">0</div><div class="stat-label">ç¸½è¨‚å–®æ•¸</div><div class="stat-sub">æœ¬æœˆ</div></div>
    <div class="stat-card green"><div class="stat-num green" id="stat-revenue">HK$0</div><div class="stat-label">å·²æ”¶æ¬¾</div><div class="stat-sub">å·²ç¢ºèª</div></div>
    <div class="stat-card pink"><div class="stat-num pink" id="stat-shipping">0</div><div class="stat-label">é¦™æ¸¯ç™¼è²¨ä¸­</div><div class="stat-sub">å¾…ç°½æ”¶</div></div>
    <div class="stat-card gold"><div class="stat-num gold" id="stat-transit">0</div><div class="stat-label">éŸ“åœ‹å‡ºç™¼ä¸­</div><div class="stat-sub">é‹é€ä¸­</div></div>
    <div class="stat-card red"><div class="stat-num red" id="stat-unpaid">0</div><div class="stat-label">å¾…ä»˜æ¬¾</div><div class="stat-sub">éœ€è·Ÿé€²</div></div>
  </div>

  <div class="one-click-section">
    <div class="one-click-title">âš¡ ä¸€éµè™•ç†åŠŸèƒ½</div>
    <div class="one-click-btns">
      <button class="btn btn-warning" onclick="oneClick('notify-unpaid')">ğŸ“¢ é€šçŸ¥æœªä»˜æ¬¾å®¢æˆ¶</button>
      <button class="btn btn-success" onclick="oneClick('mark-purchased')">âœ… æ‰¹é‡æ¨™è¨˜å·²æ¡è³¼</button>
      <button class="btn btn-primary" onclick="oneClick('send-tracking')">ğŸ“¦ ç™¼é€ç‰©æµé€šçŸ¥</button>
      <button class="btn btn-ghost" onclick="oneClick('export-pending')">ğŸ“‹ åŒ¯å‡ºå¾…è¾¦è¨‚å–®</button>
      <button class="btn btn-danger" onclick="oneClick('flag-overdue')">ğŸš¨ æ¨™è¨˜é€¾æœŸæœªä»˜æ¬¾</button>
    </div>
  </div>

  <div class="filter-bar">
    <input class="filter-input wide" type="text" id="searchInput" placeholder="ğŸ”  æœå°‹è¨‚å–®è™Ÿã€å®¢æˆ¶ã€å•†å“..." oninput="filterOrders()">
    <select class="filter-select" id="statusFilter" onchange="filterOrders()">
      <option value="">å…¨éƒ¨ç‹€æ…‹</option>
      <option value="unpaid">é¡§å®¢æœªä»˜æ¬¾</option><option value="paid">é¡§å®¢å®Œæˆä»˜æ¬¾</option>
      <option value="unpurchased">æœªæ¡è³¼</option><option value="purchased">å·²æ¡è³¼</option>
      <option value="kr-arrived">åˆ°é”éŸ“åœ‹å€‰åº«</option><option value="kr-departed">å¾éŸ“åœ‹å‡ºç™¼</option>
      <option value="hk-arrived">åˆ°é”é¦™æ¸¯</option><option value="hk-shipped">é¦™æ¸¯å¿«éç™¼è²¨</option>
      <option value="refund">è¨‚å–®å¾…é€€æ¬¾</option><option value="cancelled">è¨‚å–®å–æ¶ˆ</option>
    </select>
    <div style="display:flex;gap:5px">
      <div class="pill active" onclick="togglePill(this,'all')">å…¨éƒ¨</div>
      <div class="pill ig" onclick="togglePill(this,'ig')">ğŸ“¸ IG</div>
      <div class="pill wa" onclick="togglePill(this,'wa')">ğŸ’¬ WA</div>
      <div class="pill web" onclick="togglePill(this,'web')">ğŸŒ Web</div>
    </div>
  </div>
  <div class="table-wrap">
    <table><thead><tr><th>è¨‚å–®ç·¨è™Ÿ</th><th>æ¸ é“</th><th>å®¢æˆ¶</th><th>å•†å“</th><th>é‡‘é¡</th><th>ç‹€æ…‹</th><th>ç‰©æµå–®è™Ÿ</th><th>æ—¥æœŸ</th><th>æ“ä½œ</th></tr></thead>
    <tbody id="orderTbody"></tbody></table>
  </div>
</div>

<!-- INVENTORY PAGE -->
<div id="page-inventory" class="page-section">
  <div class="section-header">
    <div class="section-title"><span>ğŸª</span> é¦™æ¸¯ç¾è²¨åº«å­˜</div>
    <button class="btn btn-primary" onclick="openInvForm(null)">ï¼‹ æ–°å¢å•†å“</button>
  </div>
  <div class="table-wrap">
    <table><thead><tr><th>SKU</th><th>å•†å“åç¨±</th><th>å“ç‰Œ</th><th>åº«å­˜</th><th>é ç•™</th><th>å¯å”®</th><th>å…¥åº«æ—¥æœŸ</th><th>åº«å­˜ç…§ç‰‡</th><th>ç‹€æ³</th><th>æ“ä½œ</th></tr></thead>
    <tbody id="invTbody"></tbody></table>
  </div>
</div>

<!-- PHOTOS PAGE -->
<div id="page-photos" class="page-section">
  <div class="section-header">
    <div class="section-title"><span>ğŸ“¸</span> åº«å­˜ç…§ç‰‡ä¸Šå‚³ç´€éŒ„</div>
    <button class="btn btn-primary" onclick="openPhotoForm(null)">ï¼‹ æ–°å¢æ‰¹æ¬¡</button>
  </div>
  <div class="tab-bar">
    <div class="tab active" onclick="switchPhotoTab('all',this)">å…¨éƒ¨æ‰¹æ¬¡</div>
    <div class="tab" onclick="switchPhotoTab('kr',this)">ğŸ‡°ğŸ‡· éŸ“åœ‹å‡ºç™¼å‰</div>
    <div class="tab" onclick="switchPhotoTab('hk',this)">ğŸ‡­ğŸ‡° åˆ°é”é¦™æ¸¯å¾Œ</div>
    <div class="tab" onclick="switchPhotoTab('stock',this)">ğŸª ç¾è²¨åº«å­˜ç…§</div>
  </div>
  <div id="photoBatches"></div>
</div>

<!-- PROBLEMS PAGE -->
<div id="page-problems" class="page-section">
  <div class="section-header">
    <div class="section-title"><span>âš ï¸</span> å•é¡Œå›å ±èˆ‡è™•ç†</div>
    <button class="btn btn-danger" onclick="openProblemForm(null)">ï¼‹ å›å ±å•é¡Œ</button>
  </div>
  <div class="table-wrap">
    <table><thead><tr><th>å•é¡Œç·¨è™Ÿ</th><th>è¨‚å–®</th><th>é¡å‹</th><th>å„ªå…ˆç´š</th><th>æè¿°</th><th>ç‹€æ…‹</th><th>è² è²¬äºº</th><th>æ—¥æœŸ</th><th>æ“ä½œ</th></tr></thead>
    <tbody id="problemTbody"></tbody></table>
  </div>
</div>

<!-- CS PAGE -->
<div id="page-cs" class="page-section">
  <div class="section-header">
    <div class="section-title"><span>ğŸ’¬</span> å®¢æœè™•ç†ç´€éŒ„</div>
    <button class="btn btn-primary" onclick="openCSForm(null)">ï¼‹ æ–°å¢ç´€éŒ„</button>
  </div>
  <div class="cards-grid">
    <div class="info-card"><h4>æœ¬æœˆè«®è©¢</h4><div class="cs-num" style="color:var(--accent)" id="cs-stat-total">0</div><div style="font-size:11px;color:var(--text2);margin-top:4px" id="cs-stat-sub">â†‘ 12% vs ä¸Šæœˆ</div></div>
    <div class="info-card"><h4>å·²è™•ç†</h4><div class="cs-num" style="color:var(--success)" id="cs-stat-done">0</div><div style="font-size:11px;color:var(--text2);margin-top:4px" id="cs-stat-pct">å®Œæˆç‡</div></div>
    <div class="info-card"><h4>å¾…è™•ç†</h4><div class="cs-num" style="color:var(--warning)" id="cs-stat-pending">0</div><div style="font-size:11px;color:var(--text2);margin-top:4px">éœ€ä»Šæ—¥è·Ÿé€²</div></div>
    <div class="info-card"><h4>å¹³å‡å›è¦†</h4><div class="cs-num" style="color:var(--accent2)">2.4h</div><div style="font-size:11px;color:var(--text2);margin-top:4px">ç›®æ¨™ &lt; 3h</div></div>
  </div>
  <div class="table-wrap">
    <table><thead><tr><th>ç·¨è™Ÿ</th><th>é¡å‹</th><th>å„ªå…ˆç´š</th><th>æ¨™é¡Œ</th><th>æè¿°</th><th>è¯çµ¡</th><th>ç‹€æ…‹</th><th>æ—¥æœŸ</th><th>æ“ä½œ</th></tr></thead>
    <tbody id="csTbody"></tbody></table>
  </div>
</div>

</div><!-- .main -->
</div><!-- .layout -->

<!-- ORDER FORM -->
<div class="modal-overlay" id="orderFormModal">
  <div class="modal md">
    <div class="modal-header"><div class="modal-title" id="orderFormTitle">â• æ–°å¢è¨‚å–®</div><button class="modal-close" onclick="closeModal('orderFormModal')">âœ•</button></div>
    <div class="modal-body">
      <input type="hidden" id="editOrderId">
      <div class="form-row">
        <div class="form-group"><label class="form-label">ä¸‹å–®æ¸ é“ *</label><select class="form-select" id="fChannel"><option value="ig">ğŸ“¸ Instagram</option><option value="wa">ğŸ’¬ WhatsApp</option><option value="web">ğŸŒ Website</option></select></div>
        <div class="form-group"><label class="form-label">å®¢æˆ¶å§“å *</label><input class="form-input" id="fCustomer" placeholder="è¼¸å…¥å®¢æˆ¶åç¨±"></div>
      </div>
      <div class="form-group"><label class="form-label">å•†å“åç¨± *</label><input class="form-input" id="fProduct" placeholder="ä¾‹ï¼šLANEIGE å”‡è†œ Berry è‰²è™Ÿ"></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">è¨‚å–®é‡‘é¡ (HKD)</label><input class="form-input" id="fAmount" type="number" placeholder="0"></div>
        <div class="form-group"><label class="form-label">è¨‚å–®ç‹€æ…‹</label>
          <select class="form-select" id="fStatus">
            <option value="unpaid">é¡§å®¢æœªä»˜æ¬¾</option><option value="paid">é¡§å®¢å®Œæˆä»˜æ¬¾</option>
            <option value="unpurchased">æœªæ¡è³¼</option><option value="purchased">å·²æ¡è³¼</option>
            <option value="kr-arrived">åˆ°é”éŸ“åœ‹å€‰åº«</option><option value="kr-departed">å¾éŸ“åœ‹å‡ºç™¼</option>
            <option value="hk-arrived">åˆ°é”é¦™æ¸¯</option><option value="hk-shipped">é¦™æ¸¯å¿«éç™¼è²¨</option>
            <option value="refund">è¨‚å–®å¾…é€€æ¬¾</option><option value="cancelled">è¨‚å–®å–æ¶ˆ</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">ä¾›æ‡‰å•†åç¨±</label><input class="form-input" id="fSupplierName" placeholder="ä¾›æ‡‰å•†åç¨±"></div>
        <div class="form-group"><label class="form-label">è²¨æºé€£çµ</label><input class="form-input" id="fSupplier" placeholder="https://..."></div>
      </div>
      <div class="form-group"><label class="form-label">ç‰©æµå–®è™Ÿ</label><input class="form-input" id="fTracking" placeholder="ä¾‹ï¼šSF1234567890"></div>
      <div class="form-group"><label class="form-label">å‚™è¨»</label><textarea class="form-textarea" id="fNote" placeholder="ç‰¹åˆ¥è¦æ±‚ã€é¡è‰²ã€å°ºå¯¸ç­‰..."></textarea></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:6px">
        <button class="btn btn-ghost" onclick="closeModal('orderFormModal')">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="saveOrder()">ğŸ’¾ ç¢ºèªå„²å­˜</button>
      </div>
    </div>
  </div>
</div>

<!-- ORDER DETAIL -->
<div class="modal-overlay" id="detailModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modalTitle">è¨‚å–®è©³æƒ…</div>
      <div style="display:flex;gap:7px;align-items:center">
        <button class="btn btn-ghost" onclick="editFromDetail()" style="padding:5px 10px;font-size:12px">âœï¸ ç·¨è¼¯</button>
        <button class="modal-close" onclick="closeModal('detailModal')">âœ•</button>
      </div>
    </div>
    <div class="modal-body" id="modalBody"></div>
  </div>
</div>

<!-- INVENTORY FORM -->
<div class="modal-overlay" id="invFormModal">
  <div class="modal md">
    <div class="modal-header"><div class="modal-title" id="invFormTitle">â• æ–°å¢åº«å­˜å•†å“</div><button class="modal-close" onclick="closeModal('invFormModal')">âœ•</button></div>
    <div class="modal-body">
      <input type="hidden" id="editInvSku">
      <div class="form-row">
        <div class="form-group"><label class="form-label">SKU ç·¨è™Ÿ *</label><input class="form-input" id="iSku" placeholder="INV-XXX"></div>
        <div class="form-group"><label class="form-label">å“ç‰Œ</label><input class="form-input" id="iBrand" placeholder="ä¾‹ï¼šLANEIGE"></div>
      </div>
      <div class="form-group"><label class="form-label">å•†å“åç¨± *</label><input class="form-input" id="iName" placeholder="å•†å“å…¨å"></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">ç¾æœ‰åº«å­˜æ•¸é‡</label><input class="form-input" id="iStock" type="number" placeholder="0"></div>
        <div class="form-group"><label class="form-label">é ç•™æ•¸é‡</label><input class="form-input" id="iReserved" type="number" placeholder="0"></div>
      </div>
      <div class="form-group"><label class="form-label">å…¥åº«æ—¥æœŸ</label><input class="form-input" id="iArrival" type="date"></div>
      <div class="form-group">
        <label class="form-label">ğŸ“· ä¸Šå‚³åº«å­˜ç…§ç‰‡</label>
        <div class="upload-area" onclick="triggerInvUpload()" id="invUploadArea">
          <div style="font-size:28px;margin-bottom:6px">ğŸ“·</div>
          <div style="font-size:13px">é»æ“Šé¸æ“‡åœ–ç‰‡ï¼ˆå¯å¤šé¸ï¼‰</div>
          <div style="font-size:11px;color:var(--text3);margin-top:3px">æ”¯æ´ JPG / PNG / WebP</div>
        </div>
        <input type="file" id="invFileInput" accept="image/*" multiple style="display:none" onchange="handleInvPhotos(event)">
        <div class="inv-photo-preview" id="invPhotoPreview"></div>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:6px">
        <button class="btn btn-ghost" onclick="closeModal('invFormModal')">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="saveInventory()">ğŸ’¾ ç¢ºèªå„²å­˜</button>
      </div>
    </div>
  </div>
</div>

<!-- INVENTORY PHOTOS VIEWER -->
<div class="modal-overlay" id="invPhotosModal">
  <div class="modal md">
    <div class="modal-header"><div class="modal-title" id="invPhotosTitle">ğŸ“· åº«å­˜ç…§ç‰‡</div><button class="modal-close" onclick="closeModal('invPhotosModal')">âœ•</button></div>
    <div class="modal-body">
      <div class="img-grid" id="invPhotosGrid"></div>
      <div style="display:flex;justify-content:flex-end;margin-top:14px">
        <button class="btn btn-ghost" onclick="triggerInvAddPhoto()">ï¼‹ æ–°å¢ç…§ç‰‡</button>
        <input type="file" id="invAddPhotoInput" accept="image/*" multiple style="display:none" onchange="handleInvAddPhotos(event)">
      </div>
    </div>
  </div>
</div>

<!-- PHOTO BATCH FORM -->
<div class="modal-overlay" id="photoFormModal">
  <div class="modal md">
    <div class="modal-header"><div class="modal-title" id="photoFormTitle">â• æ–°å¢ç…§ç‰‡æ‰¹æ¬¡</div><button class="modal-close" onclick="closeModal('photoFormModal')">âœ•</button></div>
    <div class="modal-body">
      <input type="hidden" id="editPhotoBatch">
      <div class="form-row">
        <div class="form-group"><label class="form-label">æ‰¹æ¬¡é¡å‹ *</label>
          <select class="form-select" id="pbType">
            <option value="kr">ğŸ‡°ğŸ‡· éŸ“åœ‹å‡ºç™¼å‰</option>
            <option value="hk">ğŸ‡­ğŸ‡° åˆ°é”é¦™æ¸¯å¾Œ</option>
            <option value="stock">ğŸª ç¾è²¨åº«å­˜ç…§</option>
          </select>
        </div>
        <div class="form-group"><label class="form-label">ç›¸é—œè¨‚å–®/æ‰¹æ¬¡</label><input class="form-input" id="pbRef" placeholder="BATCH-KR-XXXXXXXX"></div>
      </div>
      <div class="form-group"><label class="form-label">å‚™è¨»</label><input class="form-input" id="pbNote" placeholder="å‚™è¨»èªªæ˜..."></div>
      <div class="form-group">
        <label class="form-label">ğŸ“· ä¸Šå‚³ç…§ç‰‡ï¼ˆå¯å¤šé¸ï¼‰</label>
        <div class="upload-area" onclick="triggerPhotoUpload()" id="photoUploadArea">
          <div style="font-size:28px;margin-bottom:6px">ğŸ“·</div>
          <div style="font-size:13px">é»æ“Šé¸æ“‡åœ–ç‰‡</div>
        </div>
        <input type="file" id="photoFileInput" accept="image/*" multiple style="display:none" onchange="handlePhotoBatchUpload(event)">
        <div class="inv-photo-preview" id="pbPhotoPreview"></div>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:6px">
        <button class="btn btn-ghost" onclick="closeModal('photoFormModal')">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="savePhotoBatch()">ğŸ’¾ ç¢ºèªå„²å­˜</button>
      </div>
    </div>
  </div>
</div>

<!-- PROBLEM FORM -->
<div class="modal-overlay" id="problemFormModal">
  <div class="modal md">
    <div class="modal-header"><div class="modal-title" id="probFormTitle">âš ï¸ æ–°å¢å•é¡Œå›å ±</div><button class="modal-close" onclick="closeModal('problemFormModal')">âœ•</button></div>
    <div class="modal-body">
      <input type="hidden" id="editProbId">
      <div class="form-row">
        <div class="form-group"><label class="form-label">ç›¸é—œè¨‚å–®ç·¨è™Ÿ</label><input class="form-input" id="pOrder" placeholder="ORD-XXXX-XXX"></div>
        <div class="form-group"><label class="form-label">å•é¡Œé¡å‹</label>
          <select class="form-select" id="pType"><option>é€€æ¬¾çˆ­è­°</option><option>ç‰©æµå»¶èª¤</option><option>æµ·é—œæŸ¥é©—</option><option>ç¼ºè²¨å•é¡Œ</option><option>å•†å“æå£</option><option>å…¶ä»–</option></select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">å„ªå…ˆç´š</label>
          <select class="form-select" id="pPriority"><option value="high">ğŸ”´ ç·Šæ€¥</option><option value="mid">ğŸŸ¡ é‡è¦</option><option value="low">ğŸŸ¢ ä¸€èˆ¬</option></select>
        </div>
        <div class="form-group"><label class="form-label">è² è²¬äºº</label><input class="form-input" id="pPerson" placeholder="è² è²¬äººå§“å"></div>
      </div>
      <div class="form-group"><label class="form-label">å•é¡Œç‹€æ…‹</label>
        <select class="form-select" id="pStatus"><option>è™•ç†ä¸­</option><option>è·Ÿé€²ä¸­</option><option>ç­‰å¾…çµæœ</option><option>å·²è§£æ±º</option></select>
      </div>
      <div class="form-group"><label class="form-label">å•é¡Œæè¿° *</label><textarea class="form-textarea" id="pDesc" placeholder="è©³ç´°æè¿°å•é¡Œæƒ…æ³..."></textarea></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:6px">
        <button class="btn btn-ghost" onclick="closeModal('problemFormModal')">å–æ¶ˆ</button>
        <button class="btn btn-danger" onclick="saveProblem()">ğŸ’¾ ç¢ºèªå„²å­˜</button>
      </div>
    </div>
  </div>
</div>

<!-- CS FORM -->
<div class="modal-overlay" id="csFormModal">
  <div class="modal md">
    <div class="modal-header"><div class="modal-title" id="csFormTitle">â• æ–°å¢å®¢æœç´€éŒ„</div><button class="modal-close" onclick="closeModal('csFormModal')">âœ•</button></div>
    <div class="modal-body">
      <input type="hidden" id="editCsId">
      <div class="form-row">
        <div class="form-group"><label class="form-label">é¡å‹</label>
          <select class="form-select" id="csType">
            <option>æŠ•è¨´</option><option>æŸ¥è©¢ç‰©æµ</option><option>é€€æ¬¾è«®è©¢</option><option>ä»£è³¼è²»ç”¨æŸ¥è©¢</option><option>ä»˜æ¬¾æ–¹å¼æŸ¥è©¢</option><option>å•†å“æŸ¥è©¢</option><option>å…¶ä»–</option>
          </select>
        </div>
        <div class="form-group"><label class="form-label">å„ªå…ˆç´š</label>
          <select class="form-select" id="csPriority"><option value="high">ğŸ”´ ç·Šæ€¥</option><option value="mid">ğŸŸ¡ é‡è¦</option><option value="low">ğŸŸ¢ ä¸€èˆ¬</option></select>
        </div>
      </div>
      <div class="form-group"><label class="form-label">æ¨™é¡Œ *</label><input class="form-input" id="csTitle" placeholder="ç°¡çŸ­æ¨™é¡Œ..."></div>
      <div class="form-group"><label class="form-label">è©³ç´°æè¿° *</label><textarea class="form-textarea" id="csDesc" placeholder="è©³ç´°æè¿°å®¢æœå…§å®¹..."></textarea></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">è¯çµ¡æ–¹å¼</label><input class="form-input" id="csContact" placeholder="WhatsApp / IG / é›»è©±..."></div>
        <div class="form-group"><label class="form-label">ç‹€æ…‹</label>
          <select class="form-select" id="csStatus"><option>è™•ç†ä¸­</option><option>è·Ÿé€²ä¸­</option><option>ç­‰å¾…å›è¦†</option><option>å·²è§£æ±º</option></select>
        </div>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:6px">
        <button class="btn btn-ghost" onclick="closeModal('csFormModal')">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="saveCS()">ğŸ’¾ ç¢ºèªå„²å­˜</button>
      </div>
    </div>
  </div>
</div>

<!-- CHANNEL CONNECT MODAL -->
<div class="modal-overlay" id="connectModal">
  <div class="modal sm">
    <div class="modal-header"><div class="modal-title" id="connectTitle">é€£æ¥æ¸ é“</div><button class="modal-close" onclick="closeModal('connectModal')">âœ•</button></div>
    <div class="modal-body" id="connectBody"></div>
  </div>
</div>

<!-- CONFIRM DELETE -->
<div class="modal-overlay" id="confirmModal">
  <div class="modal sm">
    <div class="modal-header"><div class="modal-title">ğŸ—‘ï¸ ç¢ºèªåˆªé™¤</div><button class="modal-close" onclick="closeModal('confirmModal')">âœ•</button></div>
    <div class="modal-body">
      <div class="confirm-box"><div class="ci">âš ï¸</div><p id="confirmMsg">ç¢ºå®šè¦åˆªé™¤æ­¤é …ç›®å—ï¼Ÿ<br>æ­¤æ“ä½œ<strong>ç„¡æ³•å¾©åŸ</strong>ã€‚</p></div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button class="btn btn-ghost" onclick="closeModal('confirmModal')">å–æ¶ˆ</button>
        <button class="btn btn-danger" id="confirmOkBtn">ğŸ—‘ï¸ ç¢ºèªåˆªé™¤</button>
      </div>
    </div>
  </div>
</div>

<!-- ONE-CLICK RESULT MODAL -->
<div class="modal-overlay" id="oneClickModal">
  <div class="modal sm">
    <div class="modal-header"><div class="modal-title" id="oneClickTitle">âš¡ ä¸€éµè™•ç†</div><button class="modal-close" onclick="closeModal('oneClickModal')">âœ•</button></div>
    <div class="modal-body" id="oneClickBody"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const statusMap={
  unpaid:{label:'é¡§å®¢æœªä»˜æ¬¾',cls:'s-unpaid'},paid:{label:'é¡§å®¢å®Œæˆä»˜æ¬¾',cls:'s-paid'},
  unpurchased:{label:'æœªæ¡è³¼',cls:'s-unpurchased'},purchased:{label:'å·²æ¡è³¼',cls:'s-purchased'},
  'kr-arrived':{label:'åˆ°é”éŸ“åœ‹å€‰åº«',cls:'s-kr-arrived'},'kr-departed':{label:'å¾éŸ“åœ‹å‡ºç™¼',cls:'s-kr-departed'},
  'hk-arrived':{label:'åˆ°é”é¦™æ¸¯',cls:'s-hk-arrived'},'hk-shipped':{label:'é¦™æ¸¯å¿«éç™¼è²¨',cls:'s-hk-shipped'},
  refund:{label:'è¨‚å–®å¾…é€€æ¬¾',cls:'s-refund'},cancelled:{label:'è¨‚å–®å–æ¶ˆ',cls:'s-cancelled'}
};
const channelMap={ig:{label:'Instagram',cls:'ch-ig',icon:'ğŸ“¸'},wa:{label:'WhatsApp',cls:'ch-wa',icon:'ğŸ’¬'},web:{label:'Website',cls:'ch-web',icon:'ğŸŒ'}};
const tlSteps=['unpaid','paid','unpurchased','purchased','kr-arrived','kr-departed','hk-arrived','hk-shipped'];
const tlLabels=['æœªä»˜æ¬¾','å·²ä»˜æ¬¾','æœªæ¡è³¼','å·²æ¡è³¼','éŸ“åœ‹å€‰åº«','éŸ“åœ‹å‡ºç™¼','åˆ°é”é¦™æ¸¯','é¦™æ¸¯ç™¼è²¨'];

let activeChFilter='all',currentDetailId=null,currentInvSku=null,pbTempPhotos=[],invTempPhotos=[];
let photoTabFilter='all';

let orders=[
  {id:'ORD-2402-001',channel:'ig',customer:'Chan Mei',product:'LANEIGE å”‡è†œ Berry',amount:280,status:'hk-shipped',tracking:'SF1234567890',date:'2024-02-10',supplierName:'LANEIGE å®˜ç¶²',supplier:'https://laneige.com',note:'éœ€è¦ç¦®ç›’åŒ…è£'},
  {id:'ORD-2402-002',channel:'wa',customer:'Lee Siu Ming',product:'COSRX è¸ç‰›ç²¾è¯ 96%',amount:195,status:'kr-departed',tracking:'KR-HK-77821',date:'2024-02-11',supplierName:'COSRX Korea',supplier:'',note:''},
  {id:'ORD-2402-003',channel:'web',customer:'Wong Ting',product:'SOME BY MI AHA BHA PHA',amount:150,status:'paid',tracking:'',date:'2024-02-12',supplierName:'Olive Young',supplier:'',note:'ç²‰ç´…è‰²æ¬¾å¼'},
  {id:'ORD-2402-004',channel:'ig',customer:'Lam Ka Yin',product:'INNISFREE ç¶ èŒ¶ç²¾è¯ 80ml',amount:220,status:'unpaid',tracking:'',date:'2024-02-13',supplierName:'',supplier:'',note:'ç­‰å¾…ä»˜æ¬¾ç¢ºèª'},
  {id:'ORD-2402-005',channel:'wa',customer:'Ng Siu Kwan',product:'ETUDE HOUSE çœ¼å½±ç›¤ #05',amount:340,status:'kr-arrived',tracking:'KR-0992',date:'2024-02-08',supplierName:'Etude House å¼˜å¤§',supplier:'',note:'é™å®šç‰ˆ'},
  {id:'ORD-2402-006',channel:'web',customer:'Cheung Wai',product:'Dr. Jart+ è™çš®éœœ 50ml',amount:480,status:'hk-arrived',tracking:'HK-RECV-011',date:'2024-02-07',supplierName:'Dr. Jart Official',supplier:'https://drjart.com',note:''},
  {id:'ORD-2402-007',channel:'ig',customer:'Yip Hoi Tung',product:'MISSHA è¶…æ°´ä»½å®‰ç“¶ 5pcs',amount:125,status:'unpurchased',tracking:'',date:'2024-02-14',supplierName:'',supplier:'',note:'è«‹æ¡è³¼è£œå……'},
  {id:'ORD-2402-008',channel:'wa',customer:'Kwok Tsz Wai',product:'SULWHASOO å¹³è¡¡ç²¾è¯ 35ml',amount:890,status:'purchased',tracking:'',date:'2024-02-09',supplierName:'Sulwhasoo æ–°ç¾…å…ç¨…åº—',supplier:'',note:'VIPå®¢æˆ¶'},
  {id:'ORD-2402-009',channel:'web',customer:'Ho Yan Ting',product:'ROM&ND å”‡é‡‰ #11',amount:98,status:'refund',tracking:'',date:'2024-02-05',supplierName:'',supplier:'',note:'é¡§å®¢ç”³è«‹é€€æ¬¾'},
  {id:'ORD-2402-010',channel:'ig',customer:'Tang Siu Lung',product:'TONYMOLY è‰è“é¼»è²¼',amount:65,status:'cancelled',tracking:'',date:'2024-02-03',supplierName:'',supplier:'',note:'é¡§å®¢å–æ¶ˆ'},
];

let inventory=[
  {sku:'INV-001',name:'LANEIGE å”‡è†œ Berry',brand:'LANEIGE',stock:12,reserved:3,arrival:'2024-02-01',photos:[]},
  {sku:'INV-002',name:'COSRX è¸ç‰›ç²¾è¯ 96%',brand:'COSRX',stock:8,reserved:2,arrival:'2024-02-05',photos:[]},
  {sku:'INV-003',name:'INNISFREE ç¶ èŒ¶ç²¾è¯',brand:'INNISFREE',stock:5,reserved:1,arrival:'2024-02-08',photos:[]},
  {sku:'INV-004',name:'Dr. Jart+ è™çš®éœœ',brand:'Dr. Jart+',stock:3,reserved:3,arrival:'2024-02-10',photos:[]},
  {sku:'INV-005',name:'SOME BY MI å»è§’è³ª',brand:'SOME BY MI',stock:15,reserved:4,arrival:'2024-02-12',photos:[]},
  {sku:'INV-006',name:'ROM&ND å”‡é‡‰å¥—è£',brand:'ROM&ND',stock:0,reserved:0,arrival:'2024-01-28',photos:[]},
];

let photoBatches=[
  {id:'BATCH-KR-20240210',type:'kr',ref:'ç¬¬3æ‰¹æ¬¡',note:'å‡ºç™¼è²¨å“ï¼Œå…¨æ•¸å®Œå¥½',date:'2024-02-10 14:30',photos:[]},
  {id:'BATCH-HK-20240213',type:'hk',ref:'ç¬¬3æ‰¹æ¬¡',note:'å…¨æ•¸åˆ°é½Šï¼Œç‹€æ³è‰¯å¥½',date:'2024-02-13 10:15',photos:[]},
  {id:'BATCH-KR-20240215',type:'kr',ref:'ç¬¬4æ‰¹æ¬¡',note:'ç¬¬4æ‰¹æ¬¡å‡ºç™¼',date:'2024-02-15 16:45',photos:[]},
  {id:'BATCH-HK-20240218',type:'hk',ref:'ç¬¬4æ‰¹æ¬¡',note:'å…¶ä¸­1ä»¶åŒ…è£è¼•å¾®æå£',date:'2024-02-18 09:00',photos:[]},
];

let problems=[
  {id:'PRB-001',order:'ORD-2402-009',type:'é€€æ¬¾çˆ­è­°',priority:'high',desc:'é¡§å®¢æ”¶åˆ°é¡è‰²èˆ‡åœ–ç‰‡ä¸ç¬¦ï¼Œè¦æ±‚å…¨é¡é€€æ¬¾',status:'è™•ç†ä¸­',person:'Alice',date:'2024-02-16'},
  {id:'PRB-002',order:'ORD-2402-005',type:'ç‰©æµå»¶èª¤',priority:'mid',desc:'éŸ“åœ‹å€‰åº«æ»¯ç•™è¶…é3å¤©ï¼Œéœ€è·Ÿé€²ç‰©æµå•†',status:'è·Ÿé€²ä¸­',person:'Bob',date:'2024-02-15'},
  {id:'PRB-003',order:'ORD-2402-002',type:'æµ·é—œæŸ¥é©—',priority:'high',desc:'åŒ…è£¹è¢«æµ·é—œæŠ½æŸ¥ï¼Œé è¨ˆå»¶é²5-7å€‹å·¥ä½œå¤©',status:'ç­‰å¾…çµæœ',person:'Alice',date:'2024-02-14'},
];

let csRecords=[
  {id:'CS-001',type:'æŠ•è¨´',priority:'high',title:'é¡§å®¢æŠ•è¨´å•†å“æå£',desc:'ORD-2402-009 é¡§å®¢åæ˜ æ”¶åˆ°å•†å“å¤–åŒ…è£ç ´æï¼Œè¦æ±‚è£œå¯„æˆ–é€€æ¬¾',contact:'WhatsApp: 9XXX-XXXX',status:'è™•ç†ä¸­',date:'2024-02-16'},
  {id:'CS-002',type:'æŸ¥è©¢ç‰©æµ',priority:'mid',title:'å¤šæ¬¡æŸ¥è©¢ç‰©æµé€²åº¦',desc:'5ä½é¡§å®¢æŸ¥è©¢éŸ“åœ‹å‡ºç™¼è²¨å“é€²åº¦ï¼Œå»ºè­°ä¸»å‹•ç™¼é€æ›´æ–°é€šçŸ¥',contact:'æ‰¹é‡å›è¦†',status:'è·Ÿé€²ä¸­',date:'2024-02-15'},
  {id:'CS-003',type:'ä»£è³¼è²»ç”¨æŸ¥è©¢',priority:'mid',title:'ä»£è³¼æ‰‹çºŒè²»è«®è©¢',desc:'3ä½æ–°å®¢æˆ¶è©¢å•ä»£è³¼æ‰‹çºŒè²»åŠæœ€ä½è¨‚å–®é‡‘é¡ï¼Œéœ€æ•´ç†å ±åƒ¹å–®',contact:'Instagram DM',status:'è·Ÿé€²ä¸­',date:'2024-02-14'},
  {id:'CS-004',type:'ä»˜æ¬¾æ–¹å¼æŸ¥è©¢',priority:'low',title:'è½‰æ•¸å¿«ä»˜æ¬¾æ–¹å¼æŸ¥è©¢',desc:'é¡§å®¢è©¢å•æ˜¯å¦æ”¯æ´è½‰æ•¸å¿«ï¼Œå·²ç¢ºèªæ”¯æ´ä¸¦å›è¦†',contact:'å·²è§£æ±º',status:'å·²è§£æ±º',date:'2024-02-13'},
];

// ====== ORDERS ======
function renderOrders(data){
  const tb=document.getElementById('orderTbody');
  if(!data.length){tb.innerHTML=`<tr><td colspan="9"><div class="empty-state"><div class="empty-icon">ğŸ“­</div>æ²’æœ‰ç¬¦åˆçš„è¨‚å–®</div></td></tr>`;return;}
  tb.innerHTML=data.map(o=>{
    const s=statusMap[o.status],ch=channelMap[o.channel];
    return `<tr>
      <td><span style="font-family:'Space Mono',monospace;font-size:11px;color:var(--accent);cursor:pointer" onclick="openDetail('${o.id}')">${o.id}</span></td>
      <td><span class="ch-tag ${ch.cls}">${ch.icon} ${ch.label}</span></td>
      <td><strong>${o.customer}</strong></td>
      <td style="max-width:130px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${o.product}">${o.product}</td>
      <td style="font-family:'Space Mono',monospace;color:var(--gold)">HK$${o.amount}</td>
      <td><span class="status ${s.cls}">${s.label}</span></td>
      <td style="font-family:'Space Mono',monospace;font-size:11px;color:var(--text2)">${o.tracking||'â€”'}</td>
      <td style="font-size:11px;color:var(--text2)">${o.date}</td>
      <td><div class="action-btns">
        <button class="icon-btn" title="è©³æƒ…" onclick="openDetail('${o.id}')">ğŸ‘</button>
        <button class="icon-btn" title="ç·¨è¼¯" onclick="openOrderForm('${o.id}')">âœï¸</button>
        <button class="icon-btn del" title="åˆªé™¤" onclick="confirmDelete('order','${o.id}')">ğŸ—‘ï¸</button>
      </div></td>
    </tr>`;
  }).join('');
  updateStats();
}

function updateStats(){
  const rev=orders.filter(o=>['paid','purchased','kr-arrived','kr-departed','hk-arrived','hk-shipped'].includes(o.status)).reduce((a,o)=>a+o.amount,0);
  document.getElementById('stat-total').textContent=orders.length;
  document.getElementById('stat-revenue').textContent='HK$'+rev.toLocaleString();
  document.getElementById('stat-shipping').textContent=orders.filter(o=>o.status==='hk-shipped').length;
  document.getElementById('stat-transit').textContent=orders.filter(o=>o.status==='kr-departed').length;
  document.getElementById('stat-unpaid').textContent=orders.filter(o=>o.status==='unpaid').length;
  document.getElementById('badge-orders').textContent=orders.length;
  ['unpaid','purchased','kr-departed','hk-shipped','refund'].forEach(st=>{
    const el=document.getElementById('qf-'+st);
    if(el) el.textContent=orders.filter(o=>o.status===st).length;
  });
}

function openOrderForm(id){
  const o=id?orders.find(x=>x.id===id):null;
  document.getElementById('orderFormTitle').textContent=o?'âœï¸ ç·¨è¼¯è¨‚å–®':'â• æ–°å¢è¨‚å–®';
  document.getElementById('editOrderId').value=o?o.id:'';
  ['fChannel','fCustomer','fProduct','fAmount','fStatus','fSupplierName','fSupplier','fTracking','fNote'].forEach(f=>{
    const k=f.replace(/^f/,'').toLowerCase();
    const map={fchannel:'channel',fcustomer:'customer',fproduct:'product',famount:'amount',fstatus:'status',fsuppliername:'supplierName',fsupplier:'supplier',ftracking:'tracking',fnote:'note'};
    document.getElementById(f).value=o?(o[map[f.toLowerCase()]]||''):'';
  });
  document.getElementById('orderFormModal').classList.add('open');
}

function saveOrder(){
  const id=document.getElementById('editOrderId').value;
  const cust=document.getElementById('fCustomer').value.trim();
  const prod=document.getElementById('fProduct').value.trim();
  if(!cust||!prod){showToast('âŒ è«‹å¡«å¯«å®¢æˆ¶å§“ååŠå•†å“åç¨±','error');return;}
  const data={channel:document.getElementById('fChannel').value,customer:cust,product:prod,
    amount:parseInt(document.getElementById('fAmount').value)||0,
    status:document.getElementById('fStatus').value,
    supplierName:document.getElementById('fSupplierName').value,
    supplier:document.getElementById('fSupplier').value,
    tracking:document.getElementById('fTracking').value,
    note:document.getElementById('fNote').value,
    date:new Date().toISOString().slice(0,10)};
  if(id){const idx=orders.findIndex(x=>x.id===id);orders[idx]={...orders[idx],...data};showToast('âœ… è¨‚å–®å·²æ›´æ–°ï¼š'+id);}
  else{data.id='ORD-'+Date.now().toString().slice(-6);orders.unshift(data);showToast('âœ… è¨‚å–®æ–°å¢æˆåŠŸï¼š'+data.id);}
  closeModal('orderFormModal');filterOrders();
}

function openDetail(id){
  currentDetailId=id;
  const o=orders.find(x=>x.id===id);if(!o)return;
  const s=statusMap[o.status],ch=channelMap[o.channel];
  const ci=tlSteps.indexOf(o.status);
  document.getElementById('modalTitle').innerHTML=`<span class="ch-tag ${ch.cls}">${ch.icon}</span>${o.id}<span class="status ${s.cls}">${s.label}</span>`;
  let tl='<div class="timeline">';
  tlSteps.forEach((step,i)=>{
    const cls=i<ci?'done':i===ci?'current':'';
    if(i>0)tl+=`<div class="step-line ${i<=ci?'done':''}"></div>`;
    tl+=`<div class="step-dot ${cls}">${i<ci?'âœ“':i===ci?'â—':i+1}</div>`;
  });
  tl+='</div><div class="step-label-row">'+tlLabels.map(l=>`<div class="step-label">${l}</div>`).join('')+'</div>';
  document.getElementById('modalBody').innerHTML=`
    <div class="detail-section full" style="margin-bottom:14px"><h4>ğŸ“ è¨‚å–®é€²åº¦</h4>${tl}</div>
    <div class="detail-grid" style="margin-bottom:14px">
      <div class="detail-section"><h4>ğŸ“‹ è¨‚å–®è³‡è¨Š</h4>
        <div class="detail-row"><span class="detail-label">è¨‚å–®ç·¨è™Ÿ</span><span class="detail-value" style="font-family:'Space Mono',monospace;color:var(--accent)">${o.id}</span></div>
        <div class="detail-row"><span class="detail-label">ä¸‹å–®æ—¥æœŸ</span><span class="detail-value">${o.date}</span></div>
        <div class="detail-row"><span class="detail-label">é‡‘é¡</span><span class="detail-value" style="color:var(--gold);font-family:'Space Mono',monospace;font-weight:700">HK$${o.amount}</span></div>
        <div class="detail-row"><span class="detail-label">ç‰©æµå–®è™Ÿ</span><span class="detail-value" style="font-family:'Space Mono',monospace">${o.tracking||'â€”'}</span></div>
      </div>
      <div class="detail-section"><h4>ğŸ‘¤ å®¢æˆ¶ / å•†å“</h4>
        <div class="detail-row"><span class="detail-label">å®¢æˆ¶</span><span class="detail-value"><strong>${o.customer}</strong></span></div>
        <div class="detail-row"><span class="detail-label">å•†å“</span><span class="detail-value">${o.product}</span></div>
        <div class="detail-row"><span class="detail-label">Supplier</span><span class="detail-value">${o.supplierName||'â€”'}</span></div>
        <div class="detail-row"><span class="detail-label">å‚™è¨»</span><span class="detail-value">${o.note||'ç„¡'}</span></div>
      </div>
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-ghost" style="flex:1" onclick="nextStatus('${o.id}')">â­ï¸ æ¨é€²ä¸‹ä¸€ç‹€æ…‹</button>
      <button class="btn btn-warning" style="flex:1" onclick="closeModal('detailModal');openOrderForm('${o.id}')">âœï¸ ç·¨è¼¯è¨‚å–®</button>
    </div>`;
  document.getElementById('detailModal').classList.add('open');
}

function nextStatus(id){
  const o=orders.find(x=>x.id===id);if(!o)return;
  const ci=tlSteps.indexOf(o.status);
  if(ci<0||ci>=tlSteps.length-1){showToast('å·²æ˜¯æœ€çµ‚ç‹€æ…‹');return;}
  o.status=tlSteps[ci+1];
  closeModal('detailModal');filterOrders();
  showToast('âœ… è¨‚å–®ç‹€æ…‹æ›´æ–°ï¼š'+statusMap[o.status].label);
  openDetail(id);
}

function editFromDetail(){
  const id=currentDetailId;closeModal('detailModal');openOrderForm(id);
}

// ====== INVENTORY ======
function renderInventory(){
  document.getElementById('invTbody').innerHTML=inventory.map(i=>{
    const avail=i.stock-i.reserved,pct=i.stock>0?avail/i.stock*100:0;
    const col=pct>50?'var(--success)':pct>20?'var(--warning)':'var(--danger)';
    const pc=i.photos?i.photos.length:0;
    return `<tr>
      <td style="font-family:'Space Mono',monospace;font-size:11px;color:var(--text3)">${i.sku}</td>
      <td><strong>${i.name}</strong></td>
      <td style="color:var(--text2)">${i.brand}</td>
      <td style="font-family:'Space Mono',monospace;color:var(--accent)">${i.stock}</td>
      <td style="font-family:'Space Mono',monospace;color:var(--accent2)">${i.reserved}</td>
      <td><span style="font-family:'Space Mono',monospace;font-weight:700;color:${col}">${avail}</span><div style="height:5px;border-radius:3px;background:var(--surface3);margin-top:3px;overflow:hidden;width:60px"><div style="width:${Math.min(pct,100)}%;height:100%;border-radius:3px;background:${col}"></div></div></td>
      <td style="font-size:11px;color:var(--text2)">${i.arrival}</td>
      <td><button class="btn btn-ghost" style="padding:4px 9px;font-size:11px" onclick="openInvPhotos('${i.sku}')">ğŸ“· ${pc} å¼µ</button></td>
      <td><span class="status ${avail>5?'s-paid':avail>0?'s-purchased':'s-refund'}">${avail>5?'å……è¶³':avail>0?'ä½åº«å­˜':'å·²å”®å®Œ'}</span></td>
      <td><div class="action-btns">
        <button class="icon-btn" title="ç·¨è¼¯" onclick="openInvForm('${i.sku}')">âœï¸</button>
        <button class="icon-btn del" title="åˆªé™¤" onclick="confirmDelete('inv','${i.sku}')">ğŸ—‘ï¸</button>
      </div></td>
    </tr>`;
  }).join('');
  document.getElementById('badge-inv').textContent=inventory.length;
}

function openInvForm(sku){
  const i=sku?inventory.find(x=>x.sku===sku):null;
  invTempPhotos=i&&i.photos?[...i.photos]:[];
  document.getElementById('invFormTitle').textContent=i?'âœï¸ ç·¨è¼¯åº«å­˜å•†å“':'â• æ–°å¢åº«å­˜å•†å“';
  document.getElementById('editInvSku').value=i?i.sku:'';
  document.getElementById('iSku').value=i?i.sku:'';document.getElementById('iSku').disabled=!!i;
  document.getElementById('iBrand').value=i?i.brand:'';
  document.getElementById('iName').value=i?i.name:'';
  document.getElementById('iStock').value=i?i.stock:'';
  document.getElementById('iReserved').value=i?i.reserved:'';
  document.getElementById('iArrival').value=i?i.arrival:'';
  renderInvPhotoPreview();
  document.getElementById('invFormModal').classList.add('open');
}

function triggerInvUpload(){document.getElementById('invFileInput').click();}
function handleInvPhotos(e){
  const files=[...e.target.files];
  files.forEach(f=>{const r=new FileReader();r.onload=ev=>{invTempPhotos.push(ev.target.result);renderInvPhotoPreview();};r.readAsDataURL(f);});
}
function renderInvPhotoPreview(){
  document.getElementById('invPhotoPreview').innerHTML=invTempPhotos.map((src,i)=>`
    <div class="img-thumb">
      <img src="${src}">
      <div class="del-overlay" onclick="invTempPhotos.splice(${i},1);renderInvPhotoPreview()">ğŸ—‘ï¸</div>
    </div>`).join('')+`<div class="img-placeholder" onclick="triggerInvUpload()"><div class="icon">ï¼‹</div><div>æ–°å¢</div></div>`;
}

function saveInventory(){
  const origSku=document.getElementById('editInvSku').value;
  const sku=document.getElementById('iSku').value.trim();
  const name=document.getElementById('iName').value.trim();
  if(!sku||!name){showToast('âŒ è«‹å¡«å¯« SKU åŠå•†å“åç¨±','error');return;}
  const data={sku,name,brand:document.getElementById('iBrand').value.trim(),
    stock:parseInt(document.getElementById('iStock').value)||0,
    reserved:parseInt(document.getElementById('iReserved').value)||0,
    arrival:document.getElementById('iArrival').value,photos:[...invTempPhotos]};
  if(origSku){const idx=inventory.findIndex(x=>x.sku===origSku);inventory[idx]=data;showToast('âœ… åº«å­˜å·²æ›´æ–°ï¼š'+sku);}
  else{if(inventory.find(x=>x.sku===sku)){showToast('âŒ SKU å·²å­˜åœ¨','error');return;}inventory.push(data);showToast('âœ… æ–°å¢åº«å­˜ï¼š'+sku);}
  closeModal('invFormModal');renderInventory();
}

function openInvPhotos(sku){
  currentInvSku=sku;
  const i=inventory.find(x=>x.sku===sku);
  document.getElementById('invPhotosTitle').textContent=`ğŸ“· ${i.name} â€” åº«å­˜ç…§ç‰‡`;
  const grid=document.getElementById('invPhotosGrid');
  if(!i.photos||!i.photos.length){
    grid.innerHTML=`<div style="grid-column:1/-1;text-align:center;padding:20px;color:var(--text3)">å°šæœªä¸Šå‚³ç…§ç‰‡<br><button class="btn btn-ghost" style="margin-top:10px" onclick="triggerInvAddPhoto()">ï¼‹ ä¸Šå‚³ç…§ç‰‡</button></div>`;
  } else {
    grid.innerHTML=i.photos.map((src,idx)=>`<div class="img-thumb"><img src="${src}"><div class="del-overlay" onclick="delInvPhoto('${sku}',${idx})">ğŸ—‘ï¸</div></div>`).join('')+
      `<div class="img-placeholder" onclick="triggerInvAddPhoto()"><div class="icon">ï¼‹</div><div>æ–°å¢ç…§ç‰‡</div></div>`;
  }
  document.getElementById('invPhotosModal').classList.add('open');
}

function delInvPhoto(sku,idx){
  const i=inventory.find(x=>x.sku===sku);
  i.photos.splice(idx,1);openInvPhotos(sku);renderInventory();
}
function triggerInvAddPhoto(){document.getElementById('invAddPhotoInput').click();}
function handleInvAddPhotos(e){
  const sku=currentInvSku;const i=inventory.find(x=>x.sku===sku);if(!i.photos)i.photos=[];
  const files=[...e.target.files];
  let done=0;
  files.forEach(f=>{const r=new FileReader();r.onload=ev=>{i.photos.push(ev.target.result);done++;if(done===files.length){openInvPhotos(sku);renderInventory();showToast('âœ… ç…§ç‰‡å·²æ–°å¢');}};r.readAsDataURL(f);});
  e.target.value='';
}

// ====== PHOTO BATCHES ======
function renderPhotoBatches(){
  const typeMap={kr:{label:'ğŸ‡°ğŸ‡· éŸ“åœ‹å‡ºç™¼å‰',col:'var(--accent2)'},hk:{label:'ğŸ‡­ğŸ‡° åˆ°é”é¦™æ¸¯å¾Œ',col:'var(--success)'},stock:{label:'ğŸª ç¾è²¨åº«å­˜ç…§',col:'var(--accent)'}};
  const filtered=photoTabFilter==='all'?photoBatches:photoBatches.filter(b=>b.type===photoTabFilter);
  document.getElementById('badge-photos').textContent=photoBatches.length;
  if(!filtered.length){
    document.getElementById('photoBatches').innerHTML=`<div class="empty-state"><div class="empty-icon">ğŸ“·</div>æ²’æœ‰ç…§ç‰‡æ‰¹æ¬¡</div>`;return;
  }
  document.getElementById('photoBatches').innerHTML=filtered.map(b=>{
    const t=typeMap[b.type]||typeMap.kr;
    const imgs=b.photos&&b.photos.length?
      b.photos.map((src,i)=>`<div class="img-thumb"><img src="${src}"><div class="del-overlay" onclick="delBatchPhoto('${b.id}',${i})">ğŸ—‘ï¸</div></div>`).join('')+
      `<div class="img-placeholder" onclick="addPhotoToBatch('${b.id}')"><div class="icon">ï¼‹</div></div>` :
      `<div class="img-placeholder" style="grid-column:span 4" onclick="addPhotoToBatch('${b.id}')"><div class="icon">ğŸ“·</div><div>é»æ“Šä¸Šå‚³ç…§ç‰‡</div></div>`;
    return `<div class="photo-batch">
      <div class="photo-batch-header">
        <div class="photo-batch-title"><span style="color:${t.col}">${t.label}</span><span style="font-family:'Space Mono',monospace;font-size:11px;color:var(--text3)">${b.id}</span></div>
        <div style="display:flex;align-items:center;gap:8px">
          <span class="photo-batch-meta">${b.date} &nbsp;|&nbsp; ${b.photos?b.photos.length:0} å¼µ &nbsp;|&nbsp; ${b.note}</span>
          <button class="icon-btn" onclick="openPhotoForm('${b.id}')">âœï¸</button>
          <button class="icon-btn del" onclick="confirmDelete('batch','${b.id}')">ğŸ—‘ï¸</button>
        </div>
      </div>
      <div class="img-grid">${imgs}</div>
      <input type="file" id="addphoto-${b.id}" accept="image/*" multiple style="display:none" onchange="handleAddPhotoToBatch(event,'${b.id}')">
    </div>`;
  }).join('');
}

function addPhotoToBatch(id){document.getElementById('addphoto-'+id).click();}
function handleAddPhotoToBatch(e,id){
  const b=photoBatches.find(x=>x.id===id);if(!b.photos)b.photos=[];
  const files=[...e.target.files];let done=0;
  files.forEach(f=>{const r=new FileReader();r.onload=ev=>{b.photos.push(ev.target.result);done++;if(done===files.length){renderPhotoBatches();showToast('âœ… ç…§ç‰‡å·²æ–°å¢è‡³æ‰¹æ¬¡');}};r.readAsDataURL(f);});
  e.target.value='';
}
function delBatchPhoto(id,idx){
  const b=photoBatches.find(x=>x.id===id);b.photos.splice(idx,1);renderPhotoBatches();
}

function openPhotoForm(id){
  pbTempPhotos=[];
  const b=id?photoBatches.find(x=>x.id===id):null;
  document.getElementById('photoFormTitle').textContent=b?'âœï¸ ç·¨è¼¯ç…§ç‰‡æ‰¹æ¬¡':'â• æ–°å¢ç…§ç‰‡æ‰¹æ¬¡';
  document.getElementById('editPhotoBatch').value=b?b.id:'';
  document.getElementById('pbType').value=b?b.type:'kr';
  document.getElementById('pbRef').value=b?b.ref:'';
  document.getElementById('pbNote').value=b?b.note:'';
  document.getElementById('pbPhotoPreview').innerHTML='';
  document.getElementById('photoFormModal').classList.add('open');
}
function triggerPhotoUpload(){document.getElementById('photoFileInput').click();}
function handlePhotoBatchUpload(e){
  const files=[...e.target.files];
  files.forEach(f=>{const r=new FileReader();r.onload=ev=>{pbTempPhotos.push(ev.target.result);renderPbPreview();};r.readAsDataURL(f);});
  e.target.value='';
}
function renderPbPreview(){
  document.getElementById('pbPhotoPreview').innerHTML=pbTempPhotos.map((src,i)=>
    `<div class="img-thumb"><img src="${src}"><div class="del-overlay" onclick="pbTempPhotos.splice(${i},1);renderPbPreview()">ğŸ—‘ï¸</div></div>`).join('');
}
function savePhotoBatch(){
  const eid=document.getElementById('editPhotoBatch').value;
  const type=document.getElementById('pbType').value;
  const now=new Date();
  const data={type,ref:document.getElementById('pbRef').value,note:document.getElementById('pbNote').value,
    date:now.toISOString().slice(0,10)+' '+now.toTimeString().slice(0,5)};
  if(eid){
    const idx=photoBatches.findIndex(x=>x.id===eid);
    photoBatches[idx]={...photoBatches[idx],...data};
    if(pbTempPhotos.length)photoBatches[idx].photos=[...(photoBatches[idx].photos||[]),...pbTempPhotos];
    showToast('âœ… æ‰¹æ¬¡å·²æ›´æ–°');
  } else {
    data.id='BATCH-'+type.toUpperCase()+'-'+Date.now().toString().slice(-8);
    data.photos=[...pbTempPhotos];
    photoBatches.unshift(data);showToast('âœ… æ–°å¢ç…§ç‰‡æ‰¹æ¬¡ï¼š'+data.id);
  }
  closeModal('photoFormModal');renderPhotoBatches();
}
function switchPhotoTab(tab,el){
  photoTabFilter=tab;
  document.querySelectorAll('.tab-bar .tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  renderPhotoBatches();
}

// ====== PROBLEMS ======
function renderProblems(){
  document.getElementById('problemTbody').innerHTML=problems.map(p=>`<tr>
    <td style="font-family:'Space Mono',monospace;font-size:11px;color:var(--text3)">${p.id}</td>
    <td style="font-family:'Space Mono',monospace;font-size:11px;color:var(--accent)">${p.order}</td>
    <td>${p.type}</td>
    <td><span class="priority p-${p.priority}">${p.priority==='high'?'ç·Šæ€¥':p.priority==='mid'?'é‡è¦':'ä¸€èˆ¬'}</span></td>
    <td style="max-width:160px;font-size:12px;color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${p.desc}">${p.desc}</td>
    <td><span class="status ${p.status==='å·²è§£æ±º'?'s-hk-shipped':'s-purchased'}">${p.status}</span></td>
    <td>${p.person}</td>
    <td style="font-size:11px;color:var(--text2)">${p.date}</td>
    <td><div class="action-btns">
      <button class="icon-btn" onclick="openProblemForm('${p.id}')">âœï¸</button>
      <button class="icon-btn del" onclick="confirmDelete('prob','${p.id}')">ğŸ—‘ï¸</button>
    </div></td>
  </tr>`).join('');
  document.getElementById('badge-prob').textContent=problems.filter(p=>p.status!=='å·²è§£æ±º').length;
}

function openProblemForm(id){
  const p=id?problems.find(x=>x.id===id):null;
  document.getElementById('probFormTitle').textContent=p?'âœï¸ ç·¨è¼¯å•é¡Œå›å ±':'âš ï¸ æ–°å¢å•é¡Œå›å ±';
  document.getElementById('editProbId').value=p?p.id:'';
  document.getElementById('pOrder').value=p?p.order:'';
  document.getElementById('pType').value=p?p.type:'é€€æ¬¾çˆ­è­°';
  document.getElementById('pPriority').value=p?p.priority:'high';
  document.getElementById('pPerson').value=p?p.person:'';
  document.getElementById('pStatus').value=p?p.status:'è™•ç†ä¸­';
  document.getElementById('pDesc').value=p?p.desc:'';
  document.getElementById('problemFormModal').classList.add('open');
}

function saveProblem(){
  const eid=document.getElementById('editProbId').value;
  const desc=document.getElementById('pDesc').value.trim();
  if(!desc){showToast('âŒ è«‹å¡«å¯«å•é¡Œæè¿°','error');return;}
  const data={order:document.getElementById('pOrder').value,type:document.getElementById('pType').value,
    priority:document.getElementById('pPriority').value,desc,
    status:document.getElementById('pStatus').value,person:document.getElementById('pPerson').value,
    date:new Date().toISOString().slice(0,10)};
  if(eid){const idx=problems.findIndex(x=>x.id===eid);problems[idx]={...problems[idx],...data};showToast('âœ… å•é¡Œå›å ±å·²æ›´æ–°');}
  else{data.id='PRB-'+String(problems.length+1).padStart(3,'0');problems.unshift(data);showToast('âœ… å•é¡Œå›å ±å·²æ–°å¢ï¼š'+data.id);}
  closeModal('problemFormModal');renderProblems();
}

// ====== CS RECORDS ======
function renderCS(){
  const prMap={high:'ğŸ”´ ç·Šæ€¥',mid:'ğŸŸ¡ é‡è¦',low:'ğŸŸ¢ ä¸€èˆ¬'};
  document.getElementById('csTbody').innerHTML=csRecords.map(c=>`<tr>
    <td style="font-family:'Space Mono',monospace;font-size:11px;color:var(--text3)">${c.id}</td>
    <td>${c.type}</td>
    <td><span class="priority p-${c.priority}">${c.priority==='high'?'ç·Šæ€¥':c.priority==='mid'?'é‡è¦':'ä¸€èˆ¬'}</span></td>
    <td><strong>${c.title}</strong></td>
    <td style="max-width:160px;font-size:12px;color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${c.desc}">${c.desc}</td>
    <td style="font-size:12px;color:var(--text2)">${c.contact}</td>
    <td><span class="status ${c.status==='å·²è§£æ±º'?'s-hk-shipped':'s-purchased'}">${c.status}</span></td>
    <td style="font-size:11px;color:var(--text2)">${c.date}</td>
    <td><div class="action-btns">
      <button class="icon-btn" onclick="openCSForm('${c.id}')">âœï¸</button>
      <button class="icon-btn del" onclick="confirmDelete('cs','${c.id}')">ğŸ—‘ï¸</button>
    </div></td>
  </tr>`).join('');
  const total=csRecords.length,done=csRecords.filter(c=>c.status==='å·²è§£æ±º').length;
  document.getElementById('cs-stat-total').textContent=total;
  document.getElementById('cs-stat-done').textContent=done;
  document.getElementById('cs-stat-pending').textContent=total-done;
  document.getElementById('cs-stat-pct').textContent=(total?Math.round(done/total*100):0)+'% å®Œæˆç‡';
  document.getElementById('badge-cs').textContent=total;
}

function openCSForm(id){
  const c=id?csRecords.find(x=>x.id===id):null;
  document.getElementById('csFormTitle').textContent=c?'âœï¸ ç·¨è¼¯å®¢æœç´€éŒ„':'â• æ–°å¢å®¢æœç´€éŒ„';
  document.getElementById('editCsId').value=c?c.id:'';
  document.getElementById('csType').value=c?c.type:'æŠ•è¨´';
  document.getElementById('csPriority').value=c?c.priority:'high';
  document.getElementById('csTitle').value=c?c.title:'';
  document.getElementById('csDesc').value=c?c.desc:'';
  document.getElementById('csContact').value=c?c.contact:'';
  document.getElementById('csStatus').value=c?c.status:'è™•ç†ä¸­';
  document.getElementById('csFormModal').classList.add('open');
}

function saveCS(){
  const eid=document.getElementById('editCsId').value;
  const title=document.getElementById('csTitle').value.trim();
  const desc=document.getElementById('csDesc').value.trim();
  if(!title||!desc){showToast('âŒ è«‹å¡«å¯«æ¨™é¡ŒåŠæè¿°','error');return;}
  const data={type:document.getElementById('csType').value,priority:document.getElementById('csPriority').value,
    title,desc,contact:document.getElementById('csContact').value,
    status:document.getElementById('csStatus').value,date:new Date().toISOString().slice(0,10)};
  if(eid){const idx=csRecords.findIndex(x=>x.id===eid);csRecords[idx]={...csRecords[idx],...data};showToast('âœ… å®¢æœç´€éŒ„å·²æ›´æ–°');}
  else{data.id='CS-'+String(csRecords.length+1).padStart(3,'0');csRecords.unshift(data);showToast('âœ… å®¢æœç´€éŒ„å·²æ–°å¢ï¼š'+data.id);}
  closeModal('csFormModal');renderCS();
}

// ====== DELETE ======
function confirmDelete(type,id){
  let msg='';
  if(type==='order'){const o=orders.find(x=>x.id===id);msg=`åˆªé™¤è¨‚å–® <strong>${id}</strong><br>${o?o.customer+' â€” '+o.product:''}`;}
  else if(type==='inv'){const i=inventory.find(x=>x.sku===id);msg=`åˆªé™¤åº«å­˜ <strong>${id}</strong><br>${i?i.name:''}`;}
  else if(type==='prob'){const p=problems.find(x=>x.id===id);msg=`åˆªé™¤å•é¡Œå›å ± <strong>${id}</strong>`;}
  else if(type==='cs'){const c=csRecords.find(x=>x.id===id);msg=`åˆªé™¤å®¢æœç´€éŒ„ <strong>${id}</strong><br>${c?c.title:''}`;}
  else if(type==='batch'){msg=`åˆªé™¤ç…§ç‰‡æ‰¹æ¬¡ <strong>${id}</strong>`;}
  document.getElementById('confirmMsg').innerHTML=`ç¢ºå®šè¦åˆªé™¤æ­¤é …ç›®å—ï¼Ÿæ­¤æ“ä½œ<strong>ç„¡æ³•å¾©åŸ</strong>ã€‚<br><br>${msg}`;
  document.getElementById('confirmOkBtn').onclick=()=>{doDelete(type,id);closeModal('confirmModal');};
  document.getElementById('confirmModal').classList.add('open');
}

function doDelete(type,id){
  if(type==='order'){orders=orders.filter(x=>x.id!==id);filterOrders();showToast('ğŸ—‘ï¸ è¨‚å–®å·²åˆªé™¤ï¼š'+id);}
  else if(type==='inv'){inventory.splice(inventory.findIndex(x=>x.sku===id),1);renderInventory();showToast('ğŸ—‘ï¸ åº«å­˜å·²åˆªé™¤ï¼š'+id);}
  else if(type==='prob'){problems.splice(problems.findIndex(x=>x.id===id),1);renderProblems();showToast('ğŸ—‘ï¸ å•é¡Œå›å ±å·²åˆªé™¤');}
  else if(type==='cs'){csRecords.splice(csRecords.findIndex(x=>x.id===id),1);renderCS();showToast('ğŸ—‘ï¸ å®¢æœç´€éŒ„å·²åˆªé™¤');}
  else if(type==='batch'){photoBatches.splice(photoBatches.findIndex(x=>x.id===id),1);renderPhotoBatches();showToast('ğŸ—‘ï¸ æ‰¹æ¬¡å·²åˆªé™¤');}
}

// ====== ONE CLICK ======
function oneClick(action){
  const actions={
    'notify-unpaid':{title:'ğŸ“¢ é€šçŸ¥æœªä»˜æ¬¾å®¢æˆ¶',fn:()=>{
      const list=orders.filter(o=>o.status==='unpaid');
      return `<div style="margin-bottom:12px;color:var(--text2);font-size:13px">å·²æº–å‚™å‘ä»¥ä¸‹ <strong style="color:var(--warning)">${list.length}</strong> ä½å®¢æˆ¶ç™¼é€ä»˜æ¬¾æé†’ï¼š</div>
      ${list.map(o=>`<div style="background:var(--surface2);border-radius:8px;padding:10px 12px;margin-bottom:6px;font-size:13px"><strong>${o.customer}</strong> â€” ${o.product} <span style="color:var(--gold);font-family:'Space Mono',monospace">HK$${o.amount}</span></div>`).join('')||'<div style="color:var(--text3)">æ²’æœ‰æœªä»˜æ¬¾è¨‚å–®</div>'}
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end"><button class="btn btn-ghost" onclick="closeModal('oneClickModal')">å–æ¶ˆ</button><button class="btn btn-warning" onclick="closeModal('oneClickModal');showToast('âœ… ä»˜æ¬¾æé†’å·²ç™¼é€è‡³ ${list.length} ä½å®¢æˆ¶')">ğŸ“¢ ç¢ºèªç™¼é€</button></div>`;
    }},
    'mark-purchased':{title:'âœ… æ‰¹é‡æ¨™è¨˜å·²æ¡è³¼',fn:()=>{
      const list=orders.filter(o=>o.status==='paid');
      return `<div style="margin-bottom:12px;color:var(--text2);font-size:13px">å°‡ä»¥ä¸‹ <strong style="color:var(--success)">${list.length}</strong> ç­†å·²ä»˜æ¬¾è¨‚å–®æ¨™è¨˜ç‚ºã€Œå·²æ¡è³¼ã€ï¼š</div>
      ${list.map(o=>`<div style="background:var(--surface2);border-radius:8px;padding:10px 12px;margin-bottom:6px;font-size:13px"><strong>${o.customer}</strong> â€” ${o.product}</div>`).join('')||'<div style="color:var(--text3)">æ²’æœ‰å·²ä»˜æ¬¾å¾…æ¡è³¼è¨‚å–®</div>'}
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end"><button class="btn btn-ghost" onclick="closeModal('oneClickModal')">å–æ¶ˆ</button><button class="btn btn-success" onclick="batchMark('paid','purchased');closeModal('oneClickModal')">âœ… ç¢ºèªæ‰¹é‡æ›´æ–°</button></div>`;
    }},
    'send-tracking':{title:'ğŸ“¦ ç™¼é€ç‰©æµé€šçŸ¥',fn:()=>{
      const list=orders.filter(o=>['kr-departed','hk-shipped'].includes(o.status)&&o.tracking);
      return `<div style="margin-bottom:12px;color:var(--text2);font-size:13px">å‘ä»¥ä¸‹ <strong style="color:var(--accent)">${list.length}</strong> ä½å®¢æˆ¶ç™¼é€ç‰©æµè¿½è¹¤é€šçŸ¥ï¼š</div>
      ${list.map(o=>`<div style="background:var(--surface2);border-radius:8px;padding:10px 12px;margin-bottom:6px;font-size:13px"><strong>${o.customer}</strong> <span style="font-family:'Space Mono',monospace;font-size:11px;color:var(--text2)">${o.tracking}</span></div>`).join('')||'<div style="color:var(--text3)">æ²’æœ‰å¯ç™¼é€ç‰©æµé€šçŸ¥çš„è¨‚å–®</div>'}
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end"><button class="btn btn-ghost" onclick="closeModal('oneClickModal')">å–æ¶ˆ</button><button class="btn btn-primary" onclick="closeModal('oneClickModal');showToast('âœ… ç‰©æµé€šçŸ¥å·²ç™¼é€è‡³ ${list.length} ä½å®¢æˆ¶')">ğŸ“¦ ç¢ºèªç™¼é€</button></div>`;
    }},
    'export-pending':{title:'ğŸ“‹ åŒ¯å‡ºå¾…è¾¦è¨‚å–®',fn:()=>{
      const list=orders.filter(o=>!['hk-shipped','cancelled','refund'].includes(o.status));
      return `<div style="margin-bottom:12px;color:var(--text2);font-size:13px">åŒ¯å‡º <strong style="color:var(--accent)">${list.length}</strong> ç­†é€²è¡Œä¸­è¨‚å–®è‡³ Excel</div>
      <div style="background:var(--surface2);border-radius:8px;padding:12px;margin-bottom:12px">
        ${['unpaid','paid','unpurchased','purchased','kr-arrived','kr-departed','hk-arrived'].map(s=>{const c=list.filter(o=>o.status===s).length;return c?`<div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px"><span style="color:var(--text2)">${statusMap[s].label}</span><span style="font-family:'Space Mono',monospace;color:var(--accent)">${c}</span></div>`:''}).join('')}
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end"><button class="btn btn-ghost" onclick="closeModal('oneClickModal')">å–æ¶ˆ</button><button class="btn btn-primary" onclick="closeModal('oneClickModal');exportExcel()">ğŸ“Š ç¢ºèªåŒ¯å‡º</button></div>`;
    }},
    'flag-overdue':{title:'ğŸš¨ æ¨™è¨˜é€¾æœŸæœªä»˜æ¬¾',fn:()=>{
      const list=orders.filter(o=>o.status==='unpaid');
      return `<div style="margin-bottom:12px;color:var(--text2);font-size:13px">ä»¥ä¸‹ <strong style="color:var(--danger)">${list.length}</strong> ç­†è¨‚å–®æœªä»˜æ¬¾ï¼Œç¢ºèªæ¨™è¨˜ç‚ºé€¾æœŸï¼Ÿ</div>
      ${list.map(o=>`<div style="background:rgba(255,77,109,.1);border:1px solid rgba(255,77,109,.3);border-radius:8px;padding:10px 12px;margin-bottom:6px;font-size:13px"><strong>${o.customer}</strong> â€” ${o.product} <span style="color:var(--gold);font-family:'Space Mono',monospace">HK$${o.amount}</span><div style="font-size:11px;color:var(--text3);margin-top:2px">ä¸‹å–®æ—¥æœŸï¼š${o.date}</div></div>`).join('')||'<div style="color:var(--text3)">æ²’æœ‰æœªä»˜æ¬¾è¨‚å–®</div>'}
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end"><button class="btn btn-ghost" onclick="closeModal('oneClickModal')">å–æ¶ˆ</button><button class="btn btn-danger" onclick="closeModal('oneClickModal');showToast('ğŸš¨ å·²æ¨™è¨˜ ${list.length} ç­†é€¾æœŸè¨‚å–®')">ğŸš¨ ç¢ºèªæ¨™è¨˜</button></div>`;
    }}
  };
  const a=actions[action];if(!a)return;
  document.getElementById('oneClickTitle').textContent=a.title;
  document.getElementById('oneClickBody').innerHTML=a.fn();
  document.getElementById('oneClickModal').classList.add('open');
}

function batchMark(from,to){
  orders.filter(o=>o.status===from).forEach(o=>o.status=to);
  filterOrders();showToast('âœ… æ‰¹é‡æ›´æ–°å®Œæˆ');
}

// ====== CHANNEL CONNECT ======
function showConnect(ch){
  const configs={
    ig:{title:'ğŸ“¸ é€£æ¥ Instagram',color:'linear-gradient(135deg,#833ab4,#fd1d1d,#fcb045)',
      body:`<div style="text-align:center;margin-bottom:16px"><div style="font-size:48px;margin-bottom:8px">ğŸ“¸</div><div style="font-weight:700;font-size:16px">Instagram Business API</div><div style="color:var(--text2);font-size:13px;margin-top:4px">è‡ªå‹•æ¥æ”¶ DM è¨‚å–®ä¸¦åŒæ­¥è‡³ç³»çµ±</div></div>
      <div class="form-group"><label class="form-label">Instagram å¸³è™Ÿ ID</label><input class="form-input" placeholder="@your_account" id="igAccount"></div>
      <div class="form-group"><label class="form-label">Access Token</label><input class="form-input" placeholder="EAAxxxxx..." type="password"></div>
      <div style="background:rgba(0,212,170,.1);border:1px solid rgba(0,212,170,.3);border-radius:8px;padding:10px;margin-bottom:12px;font-size:12px;color:var(--success)">âœ… Webhook ç‹€æ…‹ï¼šå·²é€£æ¥ &nbsp;|&nbsp; ä¸Šæ¬¡åŒæ­¥ï¼š5 åˆ†é˜å‰</div>
      <div style="display:flex;gap:8px;justify-content:flex-end"><button class="btn btn-ghost" onclick="closeModal('connectModal')">å–æ¶ˆ</button><button class="btn btn-primary" style="background:linear-gradient(135deg,#833ab4,#fd1d1d)" onclick="closeModal('connectModal');showToast('âœ… Instagram å·²é€£æ¥ä¸¦åŒæ­¥')">ğŸ”— ç¢ºèªé€£æ¥</button></div>`},
    wa:{title:'ğŸ’¬ é€£æ¥ WhatsApp',color:'#25d366',
      body:`<div style="text-align:center;margin-bottom:16px"><div style="font-size:48px;margin-bottom:8px">ğŸ’¬</div><div style="font-weight:700;font-size:16px">WhatsApp Business API</div><div style="color:var(--text2);font-size:13px;margin-top:4px">è‡ªå‹•æ¥æ”¶ WA è¨Šæ¯ä¸¦è½‰æ›ç‚ºè¨‚å–®</div></div>
      <div class="form-group"><label class="form-label">é›»è©±è™Ÿç¢¼ ID</label><input class="form-input" placeholder="+852 xxxx xxxx" id="waPhone"></div>
      <div class="form-group"><label class="form-label">Business Account ID</label><input class="form-input" placeholder="WABA ID..."></div>
      <div style="background:rgba(0,212,170,.1);border:1px solid rgba(0,212,170,.3);border-radius:8px;padding:10px;margin-bottom:12px;font-size:12px;color:var(--success)">âœ… é€£æ¥ç‹€æ…‹ï¼šæ­£å¸¸ &nbsp;|&nbsp; å¾…è™•ç†è¨Šæ¯ï¼š3 æ¢</div>
      <div style="display:flex;gap:8px;justify-content:flex-end"><button class="btn btn-ghost" onclick="closeModal('connectModal')">å–æ¶ˆ</button><button class="btn btn-success" onclick="closeModal('connectModal');showToast('âœ… WhatsApp å·²é€£æ¥ä¸¦åŒæ­¥')">ğŸ”— ç¢ºèªé€£æ¥</button></div>`},
    web:{title:'ğŸŒ é€£æ¥ Website',color:'var(--accent3)',
      body:`<div style="text-align:center;margin-bottom:16px"><div style="font-size:48px;margin-bottom:8px">ğŸŒ</div><div style="font-weight:700;font-size:16px">Website è¨‚å–® API</div><div style="color:var(--text2);font-size:13px;margin-top:4px">è‡ªå‹•åŒæ­¥ç¶²åº—è¨‚å–®è‡³æ­¤ç®¡ç†ç³»çµ±</div></div>
      <div class="form-group"><label class="form-label">ç¶²ç«™ URL</label><input class="form-input" placeholder="https://yourshop.com" id="webUrl"></div>
      <div class="form-group"><label class="form-label">API Key</label><input class="form-input" placeholder="sk-xxxxx..." type="password"></div>
      <div class="form-group"><label class="form-label">Webhook URLï¼ˆè¤‡è£½åˆ°ç¶²åº—ï¼‰</label><input class="form-input" value="https://proxy-system.hk/webhook/orders" readonly style="color:var(--accent3);font-size:11px;font-family:'Space Mono',monospace"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end"><button class="btn btn-ghost" onclick="closeModal('connectModal')">å–æ¶ˆ</button><button class="btn btn-success" style="background:var(--accent3);color:#000" onclick="closeModal('connectModal');showToast('âœ… Website å·²é€£æ¥ä¸¦åŒæ­¥')">ğŸ”— ç¢ºèªé€£æ¥</button></div>`}
  };
  const c=configs[ch];
  document.getElementById('connectTitle').innerHTML=`<span style="background:${c.color};-webkit-background-clip:text;-webkit-text-fill-color:transparent">${c.title}</span>`;
  document.getElementById('connectBody').innerHTML=c.body;
  document.getElementById('connectModal').classList.add('open');
}

// ====== FILTERS ======
function filterOrders(){
  const q=document.getElementById('searchInput').value.toLowerCase();
  const st=document.getElementById('statusFilter').value;
  const filtered=orders.filter(o=>{
    const mq=!q||o.id.toLowerCase().includes(q)||o.customer.toLowerCase().includes(q)||o.product.toLowerCase().includes(q);
    const ms=!st||o.status===st;
    const mc=activeChFilter==='all'||o.channel===activeChFilter;
    return mq&&ms&&mc;
  });
  renderOrders(filtered);
}

function quickFilter(st){
  document.getElementById('statusFilter').value=st;
  const firstNav=document.querySelectorAll('.nav-item')[0];
  showPage('orders',firstNav);
  filterOrders();
}

function togglePill(el,ch){
  document.querySelectorAll('.pill').forEach(p=>p.classList.remove('active'));
  el.classList.add('active');activeChFilter=ch;filterOrders();
}

function showPage(page,el){
  document.querySelectorAll('.page-section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('page-'+page).classList.add('active');
  if(el)el.classList.add('active');
  if(page==='inventory')renderInventory();
  if(page==='photos')renderPhotoBatches();
  if(page==='problems')renderProblems();
  if(page==='cs')renderCS();
}

function closeModal(id){document.getElementById(id).classList.remove('open');}

function showToast(msg,type=''){
  const t=document.getElementById('toast');
  t.textContent=msg;t.className='toast show'+(type?' '+type:'');
  clearTimeout(t._t);t._t=setTimeout(()=>t.classList.remove('show'),3000);
}

function exportExcel(){
  const wb=XLSX.utils.book_new();
  const ws1=XLSX.utils.aoa_to_sheet([
    ['è¨‚å–®ç·¨è™Ÿ','æ¸ é“','å®¢æˆ¶','å•†å“','é‡‘é¡(HKD)','ç‹€æ…‹','ç‰©æµå–®è™Ÿ','ä¸‹å–®æ—¥æœŸ','Supplier','å‚™è¨»'],
    ...orders.map(o=>[o.id,channelMap[o.channel].label,o.customer,o.product,o.amount,statusMap[o.status].label,o.tracking,o.date,o.supplierName,o.note])
  ]);
  XLSX.utils.book_append_sheet(wb,ws1,'è¨‚å–®ç¸½è¦½');
  const ws2=XLSX.utils.aoa_to_sheet([
    ['SKU','å•†å“åç¨±','å“ç‰Œ','ç¾æœ‰åº«å­˜','é ç•™æ•¸é‡','å¯å”®æ•¸é‡','å…¥åº«æ—¥æœŸ'],
    ...inventory.map(i=>[i.sku,i.name,i.brand,i.stock,i.reserved,i.stock-i.reserved,i.arrival])
  ]);
  XLSX.utils.book_append_sheet(wb,ws2,'ç¾è²¨åº«å­˜');
  const ws3=XLSX.utils.aoa_to_sheet([
    ['ç·¨è™Ÿ','é¡å‹','æ¨™é¡Œ','å„ªå…ˆç´š','æè¿°','è¯çµ¡','ç‹€æ…‹','æ—¥æœŸ'],
    ...csRecords.map(c=>[c.id,c.type,c.title,c.priority==='high'?'ç·Šæ€¥':c.priority==='mid'?'é‡è¦':'ä¸€èˆ¬',c.desc,c.contact,c.status,c.date])
  ]);
  XLSX.utils.book_append_sheet(wb,ws3,'å®¢æœç´€éŒ„');
  XLSX.writeFile(wb,`é¦™æ¸¯ä»£è³¼å ±è¡¨_${new Date().toISOString().slice(0,10)}.xlsx`);
  showToast('ğŸ“Š Excel å ±è¡¨å·²åŒ¯å‡º');
}

// Init
filterOrders();
</script>
</body>
</html>
